<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ì„œìš¸ ì•ˆì „ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        // 1. ê¸°ë³¸ ì§€ë„ (ì„œìš¸ ì¤‘ì‹¬)
        const map = L.map("map").setView([37.5665, 126.9780], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
        }).addTo(map);

        // 2. ìƒí™œì•ˆì „ì§€ë„ WMS (ë²”ì£„ì£¼ì˜êµ¬ê°„ ì „ì²´)
        const serviceKey = "02IR61SN-02IR-02IR-02IR-02IR61SN8R"; // 02IRë¡œ ì‹œì‘í•˜ëŠ” í‚¤ ì •í™•íˆ ë¶™ì—¬ë„£ê¸°

        const crimeLayer = L.tileLayer.wms(
            "https://www.safemap.go.kr/openapi2/IF_0087_WMS",
            {
                serviceKey: serviceKey,
                layers: "A2SM_CRMNLHSPOT_TOT",
                styles: "A2SM_CrmnlHspot_Tot_Tot",
                format: "image/png",
                transparent: true,
                opacity: 0.4, // íˆ¬ëª…ë„ ì¡°ì ˆë¡œ ì§€ë„ ë°°ê²½ì´ ë³´ì´ê²Œ í•¨
                maxNativeZoom: 15, // ğŸš€ ì¤Œ í™•ëŒ€ ì‹œì—ë„ ë³´ì´ë„ë¡ (15ë ˆë²¨ íƒ€ì¼ì„ í™•ëŒ€í•´ì„œ ë³´ì—¬ì¤Œ)
                // srsëŠ” ìƒëµí•´ì„œ Leaflet ê¸°ë³¸(EPSG:3857)ì— ë§ì¶”ê²Œ ë‘ 
            }
        );

        crimeLayer.addTo(map);

        // 3. ì¹´í…Œê³ ë¦¬ë³„ ë ˆì´ì–´ ê·¸ë£¹ (ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ì ìš©)
        const cctvLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
        const streetLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
        const convLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
        const entLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);

        // 4. ë°±ì—”ë“œì—ì„œ í¬ì¸íŠ¸ ë°›ì•„ì˜¤ê¸°
        fetch("http://127.0.0.1:8000/points")
            .then((res) => res.json())
            .then((data) => {
                data.features.forEach((f) => {
                    const [lon, lat] = f.geometry.coordinates;
                    const cat = f.properties.category;
                    const name = f.properties.name || "";

                    let strokeColor = "black";
                    let fillColor = "black";

                    if (cat === "cctv") {
                        strokeColor = "blue";
                        fillColor = "blue";
                    } else if (cat === "streetlight") {
                        // ğŸ”¥ ê°€ë¡œë“±: ê²€ì€ í…Œë‘ë¦¬ì— ë°ì€ ë…¸ë‘ ì±„ì›€, í¬ê¸°ë„ ì¢€ í‚¤ì›€
                        strokeColor = "black";
                        fillColor = "yellow";
                    } else if (cat === "convenience") {
                        strokeColor = "green";
                        fillColor = "green";
                    } else if (cat === "entertainment") {
                        strokeColor = "red";
                        fillColor = "red";
                    }

                    const marker = L.circleMarker([lat, lon], {
                        radius: cat === "streetlight" ? 7 : 5, // ê°€ë¡œë“±ì€ ë” í¬ê²Œ
                        color: strokeColor,     // í…Œë‘ë¦¬ ìƒ‰
                        fillColor: fillColor,   // ì±„ì›€ ìƒ‰
                        weight: 1.5,
                        fillOpacity: 0.9,
                    }).bindPopup(`<b>${cat}</b><br>${name}`);

                    if (cat === "cctv") cctvLayer.addLayer(marker);
                    else if (cat === "streetlight") streetLayer.addLayer(marker);
                    else if (cat === "convenience") convLayer.addLayer(marker);
                    else if (cat === "entertainment") entLayer.addLayer(marker);
                });

                // 5. ë ˆì´ì–´ í† ê¸€ ì»¨íŠ¸ë¡¤
                L.control
                    .layers(null, {
                        CCTV: cctvLayer,
                        ê°€ë¡œë“±: streetLayer,
                        í¸ì˜ì : convLayer,
                        ìœ í¥ì—…ì†Œ: entLayer,
                        "ë²”ì£„ì£¼ì˜êµ¬ê°„(WMS)": crimeLayer,
                    })
                    .addTo(map);
            })
            .catch((err) => {
                console.error("í¬ì¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
            });
    </script>
</body>

</html>