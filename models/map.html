<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ì„œìš¸ ì•ˆì „ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        #map {
            width: 100%;
            height: 100vh;
        }
        /* Chat UI Styles */
        #chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-size: 16px;
        }
        #chat-container {
            display: none;
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            z-index: 1000;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            flex-direction: column;
            overflow: hidden;
        }
        #chat-header {
            background: #007bff;
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 80%;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
        }
        .user-msg {
            align-self: flex-end;
            background: #007bff;
            color: white;
        }
        .bot-msg {
            align-self: flex-start;
            background: #e9ecef;
            color: black;
        }
        #chat-input-area {
            padding: 10px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        #chat-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #send-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Chat Widget -->
    <button id="chat-btn" onclick="toggleChat()">ğŸ’¬ ì•ˆì „ ë„ìš°ë¯¸</button>
    <div id="chat-container">
        <div id="chat-header">
            <span>ì•ˆì „ ì§€í‚´ì´ ì±—ë´‡</span>
            <button onclick="toggleChat()" style="background:none;border:none;color:white;cursor:pointer;">âœ•</button>
        </div>
        <div id="chat-messages">
            <div class="message bot-msg">ì•ˆë…•í•˜ì„¸ìš”! ì•ˆì „í•œ ê·€ê°“ê¸¸ì´ë‚˜ ìœ„í—˜ ì§€ì—­ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”.</div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
            <button id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // 1. ê¸°ë³¸ ì§€ë„ (ì„œìš¸ ì¤‘ì‹¬)
        const map = L.map("map").setView([37.5665, 126.9780], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 19,
        }).addTo(map);

        // 2. ìƒí™œì•ˆì „ì§€ë„ WMS (ë²”ì£„ì£¼ì˜êµ¬ê°„ ì „ì²´)
        const serviceKey = "02IR61SN-02IR-02IR-02IR-02IR61SN8R"; // 02IRë¡œ ì‹œì‘í•˜ëŠ” í‚¤ ì •í™•íˆ ë¶™ì—¬ë„£ê¸°

        const crimeLayer = L.tileLayer.wms(
            "https://www.safemap.go.kr/openapi2/IF_0087_WMS",
            {
                serviceKey: serviceKey,
                layers: "A2SM_CRMNLHSPOT_TOT",
                styles: "A2SM_CrmnlHspot_Tot_Tot",
                format: "image/png",
                transparent: true,
                opacity: 0.4, // íˆ¬ëª…ë„ ì¡°ì ˆë¡œ ì§€ë„ ë°°ê²½ì´ ë³´ì´ê²Œ í•¨
                maxNativeZoom: 15, // ğŸš€ ì¤Œ í™•ëŒ€ ì‹œì—ë„ ë³´ì´ë„ë¡ (15ë ˆë²¨ íƒ€ì¼ì„ í™•ëŒ€í•´ì„œ ë³´ì—¬ì¤Œ)
                // srsëŠ” ìƒëµí•´ì„œ Leaflet ê¸°ë³¸(EPSG:3857)ì— ë§ì¶”ê²Œ ë‘ 
            }
        );

        crimeLayer.addTo(map);

        // 3. ì¹´í…Œê³ ë¦¬ë³„ ë ˆì´ì–´ ê·¸ë£¹ (ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ì ìš©)
        const cctvLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
        const streetLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
        const convLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);
        const entLayer = L.markerClusterGroup({ chunkedLoading: true }).addTo(map);

        // 4. ë°±ì—”ë“œì—ì„œ í¬ì¸íŠ¸ ë°›ì•„ì˜¤ê¸°
        fetch("http://127.0.0.1:8000/points")
            .then((res) => res.json())
            .then((data) => {
                data.features.forEach((f) => {
                    const [lon, lat] = f.geometry.coordinates;
                    const cat = f.properties.category;
                    const name = f.properties.name || "";

                    let strokeColor = "black";
                    let fillColor = "black";

                    if (cat === "cctv") {
                        strokeColor = "blue";
                        fillColor = "blue";
                    } else if (cat === "streetlight") {
                        // ğŸ”¥ ê°€ë¡œë“±: ê²€ì€ í…Œë‘ë¦¬ì— ë°ì€ ë…¸ë‘ ì±„ì›€, í¬ê¸°ë„ ì¢€ í‚¤ì›€
                        strokeColor = "black";
                        fillColor = "yellow";
                    } else if (cat === "convenience") {
                        strokeColor = "green";
                        fillColor = "green";
                    } else if (cat === "entertainment") {
                        strokeColor = "red";
                        fillColor = "red";
                    }

                    const marker = L.circleMarker([lat, lon], {
                        radius: cat === "streetlight" ? 7 : 5, // ê°€ë¡œë“±ì€ ë” í¬ê²Œ
                        color: strokeColor,     // í…Œë‘ë¦¬ ìƒ‰
                        fillColor: fillColor,   // ì±„ì›€ ìƒ‰
                        weight: 1.5,
                        fillOpacity: 0.9,
                    }).bindPopup(`<b>${cat}</b><br>${name}`);

                    if (cat === "cctv") cctvLayer.addLayer(marker);
                    else if (cat === "streetlight") streetLayer.addLayer(marker);
                    else if (cat === "convenience") convLayer.addLayer(marker);
                    else if (cat === "entertainment") entLayer.addLayer(marker);
                });

                // 5. ë ˆì´ì–´ í† ê¸€ ì»¨íŠ¸ë¡¤
                L.control
                    .layers(null, {
                        CCTV: cctvLayer,
                        ê°€ë¡œë“±: streetLayer,
                        í¸ì˜ì : convLayer,
                        ìœ í¥ì—…ì†Œ: entLayer,
                        "ë²”ì£„ì£¼ì˜êµ¬ê°„(WMS)": crimeLayer,
                    })
                    .addTo(map);
            })
            .catch((err) => {
                console.error("í¬ì¸íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
            });
        // Chat Functions
        function toggleChat() {
            const chatBox = document.getElementById("chat-container");
            chatBox.style.display = chatBox.style.display === "flex" ? "none" : "flex";
        }

        function handleKeyPress(e) {
            if (e.key === "Enter") sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById("chat-input");
            const msg = input.value.trim();
            if (!msg) return;

            // Add user message
            addMessage(msg, "user-msg");
            input.value = "";

            try {
                // Determine map center as context (optional, simplified for now)
                const center = map.getCenter();
                
                const response = await fetch("http://127.0.0.1:8000/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        message: msg,
                        start_coords: [center.lng, center.lat], // Context example
                        end_coords: [center.lng + 0.01, center.lat + 0.01] // Dummy end for context
                    })
                });

                const data = await response.json();
                addMessage(data.response, "bot-msg");

                // Execute action if provided
                if (data.intent === "route_recommendation" && data.data && data.data.route_geojson) {
                    L.geoJSON(data.data.route_geojson, {
                        style: { color: "#00FF00", weight: 5, opacity: 0.8 }
                    }).addTo(map);
                }

            } catch (err) {
                console.error(err);
                addMessage("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "bot-msg");
            }
        }

        function addMessage(text, className) {
            const div = document.createElement("div");
            div.className = `message ${className}`;
            div.textContent = text;
            document.getElementById("chat-messages").appendChild(div);
            // Scroll to bottom
            const container = document.getElementById("chat-messages");
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>

</html>